<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Biomedical NER</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>

    mark.ent { padding: 0 .2rem; border-radius: .25rem; }
    mark.CHEMICAL { background: #fde68a; } /* amber */
    mark.DISEASE  { background: #bbf7d0; } /* green */
  </style>
</head>

<body>
  <h1>V1 : Biomedical NER</h1>
  <textarea id="input" rows="4" placeholder="For example: Aspirin can cause gastric bleeding in some patientities with Diabetes."></textarea>
  <div><button id="predict">Predict</button></div>

  <h3 id="highlightHeader" style="display:none;">Highlighted Text</h3>
  <div id="highlight"></div>

  <h3 id="entitiesHeader" style="display:none;">Entities</h3>
  <div id="table"></div>



<script>
const API = "http://localhost:8000/predict";

const input = document.getElementById("input");
const btn = document.getElementById("predict");
const highlight = document.getElementById("highlight");
const table = document.getElementById("table");

btn.onclick = async () => {
  const text = input.value.trim();
  if (!text) return alert("Enter some text");

  const res = await fetch(API, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ text })
  });
  const entities = await res.json();

  renderHighlight(text, entities);
  renderTable(text, entities);
};

function renderHighlight(text, entities) {
  if (!entities.length) { 
    highlight.textContent = text; 
    highlightHeader.style.display = "block";
    return; 
  }
  highlightHeader.style.display = "block";
  entitiesHeader.style.display = "block";
  // sort by start
  const sorted = [...entities].sort((a,b) => a.start - b.start);

  let html = "";
  let cursor = 0;

  for (const e of sorted) {
    const start = e.start ?? 0;
    const end = e.end ?? start;
    const label = e.entity || "";
    const piece = text.slice(start, end);

    // plain text before the entity
    html += escapeHtml(text.slice(cursor, start));

    
    // highlighted entity
    html += `<mark class="ent ${escapeAttr(label)}">${escapeHtml(piece)}</mark>` 
           ;

    cursor = end;
  }

  // tail text
  html += escapeHtml(text.slice(cursor));
  highlight.innerHTML = html;
}

function renderTable(text, entities) {
  if (!entities.length) { 
    table.innerHTML = "<p style='color:#666'>No entities identified.</p>"; 
    return; 
  }

  const rows = entities.map(e => {
    const span = e.text || e.word || text.slice(e.start ?? 0, e.end ?? 0);
    const label = e.entity || "";
    const score = Number(e.score || 0).toFixed(4);
    return `
      <tr>
        <td>${escapeHtml(span)}</td>
        <td>${escapeHtml(label)}</td>
        <td>${score}</td>
      </tr>`;
  }).join("");

  table.innerHTML = `
    <table>
      <thead><tr><th>Word</th><th>Entity</th><th>Score</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function escapeHtml(s=""){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeAttr(s=""){ return String(s).replace(/[^a-zA-Z0-9_-]/g, ''); }
</script>
</body>
</html>
